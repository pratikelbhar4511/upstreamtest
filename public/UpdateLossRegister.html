<!DOCTYPE html>
<html>
<div id="new-header">
</div>

<body onload="getloss()" class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">


        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    Update Losses
                </h1>
            </section>

            <!-- Main content -->

            <section class="content">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="box">
                            <div class="box-header">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-sm-3">
                                            <label> From Date</label>

                                            <input type="datetime-local" name="txtStartDate" id="txtStartDate"
                                                class="form-control"
                                                style="width: 100%;height: 30px;border-color: rgb(169, 169, 169)"
                                                required />
                                        </div>


                                        <div class="col-md-3">
                                            <label> To Date</label>

                                            <input type="datetime-local" name="txtEndDate" id="txtEndDate"
                                                class="form-control"
                                                style="width: 100%;height: 30px;border-color: rgb(169, 169, 169)"
                                                required />
                                        </div>

                                        <div class="col-md-2">

                                            <h1></h1>
                                            <button id="btnFind" name="btnFind" class="btn btn-primary"
                                                onclick="getloss()">SUBMIT</button>

                                        </div>

                                    </div>
                                </div>
                            </div>


                            <div class="box-body">

                                <div class="form-horizontal">
                                    <div class="box-body">


                                        <div class="box-body table-responsive no-padding" style="height: 700px; overflow-x: auto">
                                            <table id="tblLossData" class="table table-hover" >
                                                <thead>

                                                    <tr>
                                                        <th>Sr. No.</th>
                                                        <th>Speed Low Start Time</th>
                                                        <th>Work Cell</th>
                                                        <th>Event Description</th>
                                                    </tr>
                                                </thead>

                                                <tbody id="tbodyLossid">
                                                    <tr>

                                                    </tr>
                                                </tbody>

                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- create Modal popup for update site register -->
            <div id="update" class="form-horizontal">
                <div class="box-body">
                    <div class="modal fade" id="UpdateModal" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">

                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <h4 class="modal-title" id="myModalCreate">Update Loss </h4>
                                </div>

                                <div class="modal-body">

                                    <div class="box-body">
                                        <p class="col-md-12" id="project_no_Error" style="color: red;"></p>
                                        <div class="row">

                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label">Speed Low Start Time</label>
                                                    <div class="col-sm-6">
                                                        <input type="text" name="txtupdatestart"
                                                            id="txtupdatestart" placeholder="Enter Loss Code"
                                                            class="form-control" style="width: 200px;" required
                                                            readonly />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label">Work Cell</label>
                                                    <div class="col-sm-6">
                                                        <input type="text" name="txtupdateworkcell"
                                                            id='txtupdateworkcell' placeholder="Enter Work Cell"
                                                            class="form-control" style="width: 200px;" required
                                                            readonly />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label">Event Description</label>
                                                    <div class="col-sm-6">
                                                        <select id="ddlevent" class="eventcls" style="width: 200px;height: 30px">
                                                            <option></option>
                                                            <option></option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label id="lblerr" name="lblupdatecpass" style="color:red"></label>
                                            </div>

                                        </div>


                                        <div class="modal-footer">
                                         
                                            <button id="btn_add" name="ADD" class="btn btn-primary col-sm-offset-4"
                                                onclick="sendDataToUpdate()">SUBMIT</button>

                                            <button type="button" class="btn btn-primary"
                                                data-dismiss="modal">Close</button>
                                        </div>

                                    </div>

                                </div>
                            </div>

                        </div>


                    </div>
                </div>
            </div>
        </div><!-- /.content-wrapper -->
    </div>

    <div id="new-footer">
    </div>

    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- jvectormap -->
    <link rel="stylesheet" href="plugins/jvectormap/jquery-jvectormap-1.2.2.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
                folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
    <!-- Common.js -->
    <script src="javascripts/common.js"></script>

    <!-- jQuery 2.1.4 -->
    <script src="plugins/jQuery/jQuery-2.1.4.min.js"></script>
    <!-- Bootstrap 3.3.5 -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="plugins/fastclick/fastclick.min.js"></script>

    <!-- Sparkline -->
    <script src="plugins/sparkline/jquery.sparkline.min.js"></script>
    <!-- jvectormap -->
    <script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <!-- SlimScroll 1.3.0 -->
    <script src="plugins/slimScroll/jquery.slimscroll.min.js"></script>

    <script>
        $(document).ready(function () {

            var today = new Date();

            var dateFormat = "Y-m-d";
            date = format(today, dateFormat);

            $("#txtStartDate").val(date + "T00:00");
            $("#txtEndDate").val(date + "T23:59");

            $("#txtDate").val(date + "T00:00");

            Bindloss();
           getloss();
        });
        //Global Variables
        var selectedrow;

        function getloss() {

            $("#tbodyLossid").empty();
        
            debugger;
            var frmDate = document.getElementById("txtStartDate").value;
            var sDate = frmDate.replace("T", " ");
            //var sDate = new Date(frmDate);

        var toDate = document.getElementById("txtEndDate").value;
        var eDate = toDate.replace("T", " ");

        //  $.get("/getlossesdata",{sDate:sDate,eDate:eDate}, function (data) {
            $.ajax({
                type: 'GET',
                url: '/getlossdata',
                data: {
                    sDate: sDate,
                    eDate: eDate
                },
            async: false,
            success: function (data) {
                if (data != null) {
                    var response = data.recordset;
                    if (response.length > 0) {
                        $.each(response, function (i, d) {
                            var datetime = response[i].RowInsertTime;
                            var dateformat2 = datetime.split('T');
                            var date1 = dateformat2[0];
                            var time = dateformat2[1].split('Z');
                            var time1 = time[0];

                            var RowinsertTime = date1 + " " + time1;

                            debugger;
                            console.log(i);
                            var row = '<tr>';
                            row += '<td></td>';
                            row += '<td>' + RowinsertTime + '</td>';
                            row += '<td>' + d["WorkcellDesc"] + '</td>';
                            row += '<td>' + d["LossDescription"] + '</td>';
                            row += '<td>' + '<button class="btn btn-primary" onclick="return showpopup(this)">Edit<i class="fas fa-user-edit"></i></button>' + '</td>';

                            row += '</tr>';
                            $('#tblLossData tbody').append(row);

                        });
                        addSerialNumber("tblLossData");
                    }
                }
               }
            })
    }

    function Bindloss() {
        debugger;
        'use strict';
        $.ajax({

            type: "GET",
                        url: "/getlosses",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                          async:false,
                        success: function (result) {
                            debugger;
                            var options = '';
                            var response = JSON.parse(JSON.stringify(result.recordset));

                            $.each(response, function (i, d) {
                                if (i == 0) {
                                    options += '<option value="' + d["LossCode"] + '" selected>' + d["LossDescription"] + '</option>';
                                }
                                else {
                                    options += '<option value="' + d["LossCode"] + '">' + d["LossDescription"] + '</option>';
                                }
                            });
                            $('.eventcls').html(options);


                        }

                    })

                }


        // sending table data to popup window
        function showpopup(rowIndexOfGridview) {
            debugger;
            selectedrow = rowIndexOfGridview.parentNode.parentNode;


            var losscode = selectedrow.cells[1].innerHTML;
            txtupdatestart.value = losscode;

            var lossdesc = selectedrow.cells[2].innerHTML;
            txtupdateworkcell.value = lossdesc;

            var action = selectedrow.cells[3].innerHTML;
            $('#ddlevent option').map(function () {
                        if ($(this).text() == action) return this;
                    }).attr('selected', 'selected');
         

            $("#UpdateModal").modal('show');

        }
        
        function sendDataToUpdate() {
            // Required Field validation
            debugger;
            var StartDate = document.getElementById("txtupdatestart").value;
           
            var workcell = document.getElementById("txtupdateworkcell").value;
            var lossdesc = document.getElementById("ddlevent").value;

            var b = document.getElementById("ddlevent");
            var loss = b.options[b.selectedIndex].innerHTML;


            if (StartDate == "" || workcell == "" || lossdesc == "" ||
            StartDate == null || workcell == null || lossdesc == null) {
                alert("Some Field is missing.. Please Enter Data.");
            }
            else {
                //Updation code for site updates

                $.post("/updatelossdesc",
                    { StartDate: StartDate, workcell: workcell, lossdesc: lossdesc },
                    function (data) {

                        if (data != null) {
                            var response = data.rowsAffected;
                            if (response.length > 0) {

                                $("#UpdateModal").modal('hide');
                                alert("Data Updated successfully...");

                                selectedrow.cells[1].innerHTML = StartDate;
                                selectedrow.cells[2].innerHTML = workcell;
                                selectedrow.cells[3].innerHTML = loss;
                            }
                        }
                    });

            }

        }

    </script>

    <script>
        $("#new-header").load("header.html");
        $("#new-footer").load("footer.html");
    </script>
</body>

</html>