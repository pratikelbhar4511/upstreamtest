<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
</head>
<style>
    * {
        box-sizing: border-box;
    }

    #myInput2 {
        background-image: url('https://www.w3schools.com/css/searchicon.png');
        background-position: 10px 10px;
        background-repeat: no-repeat;
        width: 100%;
        font-size: 14px;
        padding: 12px 20px 12px 40px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
    }

    #tblLossData {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid #ddd;
        font-size: 14px;
    }

    #tblLossData th,
    #tblLossData td {
        text-align: left;
        padding: 5px;
    }

    #tblLossData tr {
        border-bottom: 1px solid #ddd;
    }

    #tblLossData tr.header,
    #tblLossData tr:hover {
        background-color: #DCDCDC;
    }
</style>



<div id="new-header"></div>

<body class="hold-transition skin-blue sidebar-mini">

    <div class="wrapper">

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <section>

            </section>
            <section class="content-header">

                <h1 id="div1" style="height:100%;float:left;"> <span class="glyphicon glyphicon-flash"
                        style="font-size:30px;color:red;"></span>
                    Critical Losses <h1 id="dashboardtitle" style="margin-top:8px; width:100%;height:100%;"> </h1>
                </h1>
            </section>

            <section class="content" style="margin-top: 40px;">

                <div class="row">
                    <div class="col-xs-12">
                        <div class="box" style=" border-top: 3px solid green">

                            <div class="box-header">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-sm-3">
                                            <label> From Date</label>

                                            <input type="datetime-local" name="txtStartDate" id="txtStartDate"
                                                class="form-control"
                                                style="width: 100%;height: 30px;border-color: rgb(169, 169, 169)"
                                                required />
                                        </div>


                                        <div class="col-md-3">
                                            <label> To Date</label>

                                            <input type="datetime-local" name="txtEndDate" id="txtEndDate"
                                                class="form-control"
                                                style="width: 100%;height: 30px;border-color: rgb(169, 169, 169)"
                                                required />
                                        </div>

                                        <div class="col-md-2">

                                            <h1></h1>
                                            <button id="btnFind" name="btnFind" class="btn btn-primary"
                                                onclick="LossDataShow()">SUBMIT</button>

                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="box-body">
                                   <div class="box-body table-responsive no-padding col-md-12 ">
                                    <!-- style="height: 300px; overflow-x: auto" -->
                                    <input type="text" id="myInput2" onkeyup="searchasset2()"
                                        placeholder="Search for loss..." title="Type in a name">

                                        <div style="float: right;margin-bottom: 5px">
                                            <button id="btnExport" class="btn btn-primary"
                                                onclick="exportTableToExcel('tblLoss')">Export
                                                To Excel</button>
                                                <!-- <button id="btnFind" name="btnFind" class="btn btn-success" style="float:right"
                                                onclick="showData()">View Details</button> -->
                                        </div>

                                       

                                    <table id="tblLoss" class="table table-hover">
                                        <thead>

                                            <tr>
                                                <td id="row-1"></td>
                                                <td id="row-2" align="Left"></td>

                                            </tr>
                                            <tr bgcolor="#008080">
                                                <th style="color:white">Sr. No.</th>
                                                <th style="color:white">Work Cell</th>
                                                <th style="color:white">Loss Code</th>
                                                <th style="color:white">Event Description</th>
                                                <th style="color:white">Action</th>
                                                <th style="color:white">Total Duration Of Loss</th>
                                                <th style="color:white">Total Count Of Duration</th>
                                                <th style="color:white">Avarage Of Duration</th>
                                                <th style="color:white">Minimun Duration</th>
                                                <th style="color:white">Maximum Duration</th>
                                                <!-- <th style="color:white">View Details</th> -->
                                            </tr>
                                        </thead>

                                        <tbody id="tbodyLoss">
                                            <tr>

                                            </tr>
                                        </tbody>

                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        

        </div>
        <!-- /.content-wrapper -->
    </div>

    <div id="add_project_frm" class="form-horizontal">
        <div class="box-body" style="width: 90%">
            <div class="modal fade" id="createModal" tabindex="-1" role="dialog" >
                <div class="modal-dialog" role="document">
                    <div class="modal-content" style="width: 160%">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" id="myModalCreate">Loss Details</h4>
                        </div>

                        <div class="modal-body">

                            <div class="box-body">

                                <div class="box-body table-responsive  col-md-12" style="height: 700px; overflow-x: auto">
                                    <!-- style="height: 300px; overflow-x: auto" -->
                                    <!-- <input type="text" id="myInput2" onkeyup="searchasset2()"
                                        placeholder="Search for loss..." title="Type in a name"> -->

                                    <table id="tblLossData" class="table table-hover">
                                        <thead>

                                            <tr  bgcolor="#008080">
                                                <th style="color:white">Sr. No.</th>
                                                <th style="color:white">Work Cell</th>
                                                <th style="color:white">Speed Low Start Time</th>
                                                <th style="color:white">Speed Low End Time</th>
                                                <th style="color:white">Duration of Loss</th>
                                                <th style="color:white">Event Description</th>

                                            </tr>
                                        </thead>

                                        <tbody id="tbodyParamid2">
                                            <tr>

                                            </tr>
                                        </tbody>

                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>


            </div>
        </div>
    </div>
    <div id="new-footer">
    </div>

    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- jvectormap -->
    <link rel="stylesheet" href="plugins/jvectormap/jquery-jvectormap-1.2.2.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
                folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
    <!-- Common.js -->
    <script src="javascripts/common.js"></script>

    <!-- jQuery 2.1.4 -->
    <script src="plugins/jQuery/jQuery-2.1.4.min.js"></script>
    <!-- Bootstrap 3.3.5 -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="plugins/fastclick/fastclick.min.js"></script>

    <!-- Sparkline -->
    <script src="plugins/sparkline/jquery.sparkline.min.js"></script>
    <!-- jvectormap -->
    <script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <!-- SlimScroll 1.3.0 -->
    <script src="plugins/slimScroll/jquery.slimscroll.min.js"></script>

    <!-- moment.js -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.js"></script> -->
    <script src="plugins/moment.js/moment.js"></script>
    <script>

        //Global Variables
        var selectedrow;

        $(document).ready(function () {

            var today = new Date();

            var dateFormat = "Y-m-d";
            date = format(today, dateFormat);

            $("#txtStartDate").val(date + "T00:00");
            $("#txtEndDate").val(date + "T23:59");

            $("#txtDate").val(date + "T00:00");

            LossDataShow();
        });

        function searchasset2() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("myInput2");
            filter = input.value.toUpperCase();
            table = document.getElementById("tblLoss");
            tr = table.getElementsByTagName("tr");
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[2];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function showData() {
            $('#createModal').modal('show');
            showData1() ;
        }

        function showData1() {
           
debugger;
            var frmDate = document.getElementById("txtStartDate").value;
            var sDate = frmDate.replace("T", " ");
            //var sDate = new Date(frmDate);

            var toDate = document.getElementById("txtEndDate").value;
            var eDate = toDate.replace("T", " ");
            //var eDate = new Date(toDate);

            $("#tbodyParamid2").empty();

            $.ajax({
                type: 'GET',
                url: '/getlossesdata',
                data: {
                    sDate: sDate,
                    eDate: eDate
                },
                success: function (result) {
                    debugger;
                    if (result != null) {
                        var data = result.recordset;
                        if (data.length > 0) {

                            var currentlosscode = 0, finallosscode = 0, lossdesc;
                            var lossduration = 0, lossstarttime = 0, lossendtime = 0, WorkcellDesc = 0;
                            var lossdataarr = [];
                            var lossdata = data;
                            $.each(lossdata, function (i, d) {
                                currentlosscode = d.Losscode;
                                WorkcellDesc = d.WorkcellDesc;
                                //if loss found i.e. other than 0
                                if (currentlosscode != 0) {
                                    //if more than 1 loss found one after another
                                    if (currentlosscode != finallosscode && finallosscode != 0) {
                                        if (lossendtime != 0) {
                                            //save 2nd loss time as endtime of 1st loss
                                            lossendtime = d.RowInsertTime;

                                            //calculate loss duration
                                            lossduration = moment.utc(moment(lossendtime, "YYYY-MM-DD HH:mm:ss").diff(moment(lossstarttime, "YYYY-MM-DD HH:mm:ss"))).format("HH:mm:ss");
                                            //push final data in new array
                                            if (lossstarttime != 0 && finallosscode != 0) {

                                                // lossdataarr.push({
                                                //     "losscode": finallosscode,
                                                //     "lossstarttime": lossstarttime,
                                                //     "lossendtime": lossendtime,
                                                //     "lossduration": lossduration,
                                                //     "lossdesc": lossdesc,
                                                //     "WorkcellDesc":WorkcellDesc
                                                // });

                                                finallosscode = 0;
                                                lossstarttime = 0;
                                                lossendtime = 0;
                                                lossduration = 0;
                                                lossdesc = "";
                                            }

                                            //save 2nd loss as new loss
                                            if (lossstarttime == 0) {
                                                finallosscode = currentlosscode;
                                                lossstarttime = d.RowInsertTime;
                                                lossdesc = d.LossDescription;
                                            }
                                        }
                                    }
                                    //fir loss found save its starttime
                                    else {

                                        if (lossstarttime == 0) {
                                            finallosscode = currentlosscode;
                                            lossstarttime = d.RowInsertTime;
                                            lossdesc = d.LossDescription;
                                        }
                                    }
                                }
                                //to get end time of founded loss
                                else if (currentlosscode == 0) {
                                    if (lossendtime == 0 && lossstarttime != 0) {
                                        lossendtime = d.RowInsertTime;

                                        //calculate loss duration
                                        lossduration = moment.utc(moment(lossendtime, "YYYY-MM-DD HH:mm:ss").diff(moment(lossstarttime, "YYYY-MM-DD HH:mm:ss"))).format("HH:mm:ss");

                                        //push final data in new array
                                        if (lossstarttime != 0 && finallosscode != 0) {

                                            // lossdataarr.push({
                                            //     "losscode": finallosscode,
                                            //     "lossstarttime": lossstarttime,
                                            //     "lossendtime": lossendtime,
                                            //     "lossduration": lossduration,
                                            //     "lossdesc": lossdesc,
                                            //     "WorkcellDesc":WorkcellDesc
                                            // });
                                        }
                                        var lossstarttimearr = lossstarttime.split(".");
                                        lossstarttime = lossstarttimearr[0].replace("T", " ");

                                        var lossendtimearr = lossendtime.split(".");
                                        lossendtime = lossendtimearr[0].replace("T", " ");

                                        var row = '<tr>';
                                        row += '<td></td>';
                                        row += '<td>' + WorkcellDesc + '</td>';
                                        row += '<td>' + lossstarttime + '</td>';
                                        row += '<td>' + lossendtime + '</td>';
                                        row += '<td>' + lossduration + '</td>';
                                        row += '<td>' + lossdesc + '</td>';
                                        row += '</tr>';

                                        $('#tblLossData tbody').append(row);

                                        finallosscode = 0;
                                        lossstarttime = 0;
                                        lossendtime = 0;
                                        lossduration = 0;
                                        lossdesc = "";
                                    }
                                }


                            });

                            addSerialNumberLoss("tblLossData");
                           
                        }
                    }
                }
            });
        }


        function LossDataShow() {

            var frmDate = document.getElementById("txtStartDate").value;
            var sDate = frmDate.replace("T", " ");
          

            var toDate = document.getElementById("txtEndDate").value;
            var eDate = toDate.replace("T", " ");
           

            $("#tbodyLoss").empty();

            $.ajax({
                type: 'GET',
                url: '/getlossesdata',
                data: {
                    sDate: sDate,
                    eDate: eDate
                },
                success: function (result) {
                    if (result != null) {
                        var data = result.recordset;
                        if (data.length > 0) {

                          var lossdata=[];
                            var lossdataArray = data;
                            
                              
                               var lineArray=[],flags = [];
                                for (var m = 0; m < lossdataArray.length; m++) {
                                if (flags[lossdataArray[m].WorkcellDesc]) continue;
                                flags[lossdataArray[m].WorkcellDesc] = true;
                                lineArray.push(lossdataArray[m].WorkcellDesc);

                            }        
                            for(var n=0;n<lineArray.length;n++)
                                {
                                      var line1=lineArray[n];
                                    
                                      lossdata = lossdataArray.filter(function (el) {
                                    return el.WorkcellDesc == line1;
                                });

                                var currentlosscode = 0, finallosscode = 0, lossdesc;
                            var lossduration = 0, lossstarttime = 0, lossendtime = 0, WorkcellDesc = 0;
                            var lossdataarr = [];var timesInSeconds=[],Action=[];

                                    $.each(lossdata, function (i, d) {
                           // debugger;
                          
                                currentlosscode = d.Losscode;
                                WorkcellDesc = d.WorkcellDesc;
                              
                                timesInSeconds[i] =0;
                                //if loss found i.e. other than 0
                                if (currentlosscode != 0) {
                                    //if more than 1 loss found one after another
                                    if (currentlosscode != finallosscode && finallosscode != 0) {
                                        // if (lossendtime != 0) {
                                            //save 2nd loss time as endtime of 1st loss
                                            lossendtime = d.RowInsertTime;

                                            //calculate loss duration
                                            lossduration = moment.utc(moment(lossendtime, "YYYY-MM-DD HH:mm:ss").diff(moment(lossstarttime, "YYYY-MM-DD HH:mm:ss"))).format("HH:mm:ss");
                                             //var lossduration2=lossduration.getUTCSeconds();
                                            // console.log("lossduration.." + lossduration);
                                            // console.log("lossduration1.." + totalSecs);

                                            //push final data in new array
                                            if (lossstarttime != 0 && finallosscode != 0) {

                                                lossdataarr.push({
                                                    "losscode": finallosscode,
                                                    "lossstarttime": lossstarttime,
                                                    "lossendtime": lossendtime,
                                                    "lossduration": lossduration,
                                                    "lossdesc": lossdesc,
                                                    "WorkcellDesc": WorkcellDesc,
                                                    "Action":Action
                                                });

                                                finallosscode = 0;
                                                lossstarttime = 0;
                                                lossendtime = 0;
                                                lossduration = 0;
                                                lossdesc = "";
                                               
                                            }

                                            //save 2nd loss as new loss
                                            if (lossstarttime == 0) {
                                                finallosscode = currentlosscode;
                                                lossstarttime = d.RowInsertTime;
                                                lossdesc = d.LossDescription;
                                                Action=d.Action;
                                            }
                                        //}
                                    }
                                    //fir loss found save its starttime
                                    else {

                                        if (lossstarttime == 0) {
                                            finallosscode = currentlosscode;
                                            lossstarttime = d.RowInsertTime;
                                            lossdesc = d.LossDescription;
                                            Action=d.Action;
                                        }
                                    }
                                }
                                //to get end time of founded loss
                                else if (currentlosscode == 0) {
                                    if (lossendtime == 0 && lossstarttime != 0) {
                                        lossendtime = d.RowInsertTime;

                                        //calculate loss duration
                                        lossduration = moment.utc(moment(lossendtime, "YYYY-MM-DD HH:mm:ss").diff(moment(lossstarttime, "YYYY-MM-DD HH:mm:ss"))).format("HH:mm:ss");
                                       
                                        //var lossduration2=lossduration.getUTCSeconds();
                                       // console.log("lossduration.." + lossduration);
                                       // console.log("lossduration1.." + totalSecs);
                                        //push final data in new array
                                        if (lossstarttime != 0 && finallosscode != 0) {

                                            lossdataarr.push({
                                                "losscode": finallosscode,
                                                "lossstarttime": lossstarttime,
                                                "lossendtime": lossendtime,
                                                "lossduration": lossduration,
                                                "lossdesc": lossdesc,
                                                "WorkcellDesc": WorkcellDesc,
                                                "Action":Action
                                            });
                                        }
                                        var lossstarttimearr = lossstarttime.split(".");
                                        lossstarttime = lossstarttimearr[0].replace("T", " ");

                                        var lossendtimearr = lossendtime.split(".");
                                        lossendtime = lossendtimearr[0].replace("T", " ");

                                        finallosscode = 0;
                                                lossstarttime = 0;
                                                lossendtime = 0;
                                                lossduration = 0;
                                                lossdesc = "";
                                             
                                    }
                                }
                            });
                                //#region avg,count,min,max logic##///

                                var count = lossdataarr.length;
debugger;
                            var flags = [], code = [], losstime = [], codeloss = [],lossname=[];
                            for (var m = 0; m < count; m++) {
                                if (flags[lossdataarr[m].lossdesc]) continue;
                                flags[lossdataarr[m].lossdesc] = true;
                                lossname.push(lossdataarr[m].lossdesc);
                            }

                            for (var z = 0; z < count; z++) {
                                if (flags[lossdataarr[z].losscode]) continue;
                                flags[lossdataarr[z].losscode] = true;
                                code.push(lossdataarr[z].losscode);
                            }

                           console.log("loss code.."+code);
                           
                           var sepratedarr = [],linearr=[];
                            for (var k = 0; k < code.length; k++) {
                                var val = code[k];
var lossname1=lossname[k];
                                 sepratedarr = lossdataarr.filter(function (el) {
                                    return el.losscode == val;
                                      
                                });

                                action1=sepratedarr[0].Action;

                                //var line=[],
                                var action1;
                                var losstime=[];
                                for (var y = 0; y < sepratedarr.length; y++) {
                                // if (flags[sepratedarr[y].WorkcellDesc]) continue;
                                // flags[sepratedarr[y].WorkcellDesc] = true;
                                // line.push(sepratedarr[y].WorkcellDesc);

                               
                                               
                               
                                // for(var l=0;l<line.length;l++)
                                // {
                                //       var line1=line[l];
                                    
                                // linearr = sepratedarr.filter(function (el) {
                                //     return el.WorkcellDesc == line1;
                                      
                                // });
                                // console.log("line.."+linearr);

                             //var flags = [],losstime=[];
                          // for (var x = 0; x < linearr.length; x++) {

                            //losstime[x] = linearr[x].lossduration;
                            losstime[y] = sepratedarr[y].lossduration;
                               }
                              // console.log("loss code.." + losstime);

                               losstime.sort(function (a, b) {
                                   //return new Date('2001/01/01 ' + a) - new Date('2001/01/01 ' + b);
                                   if (a > b) { return -1; }
                                   if (a < b) { return 1; }
                                   return 0;
                               });

                               //alert("Min: " + arr[0] + "     Max: " + arr[arr.length - 1]);
                                var Min=losstime[losstime.length - 1];
                                var Max=losstime[0];
                               // var Max = Math.max.apply(null, losstime);
                               console.log("Max: " + losstime[0]);
                               // var Min = Math.min.apply(null, losstime);
                               console.log("Min: " + losstime[losstime.length - 1]);

                               var total = 0;
                               for(var a=0;a<losstime.length;a++){
                               var pieces = losstime[a].split(':');

                               var hrs = Number(pieces[0]);
                               var mins = Number(pieces[1]);
                               var secs = Number(pieces[2]);

                               var totalSecs = hrs * 60 * 60;
                               totalSecs += mins * 60;
                               totalSecs += secs;
                               // add to array
                               timesInSeconds[a] = totalSecs;
                               }
                               console.log("timesInSeconds" + timesInSeconds);
                              // for (var j = 0; j < linearr.length; j++) {
                                for (var j = 0; j < sepratedarr.length; j++) {
                                if (count[j] != '') {
                                    total = total + Number(timesInSeconds[j]);
                                }

                            }
                            console.log('total: ' + total);
                            var avgMinst = Math.floor(total / 60);
                            var avgSecst = total - (60 * avgMinst);
                            var avgHrst = Math.floor(avgMinst / 60);
                            console.log('hourst: ' + avgHrst);
                            avgMinst = avgMinst - (60 * avgHrst);

                            // add leading zeros for seconds, minutes
                            avgHrst=('0' + avgHrst).slice(-2);
                            avgSecst = ('0' + avgSecst).slice(-2);
                            avgMinst = ('0' + avgMinst).slice(-2);
                            console.log("avgSecstotal.." + avgSecst);
                            console.log("avgMinstotal.." + avgMinst);
                            var finaltotal = avgHrst + ':' + avgMinst + ':' + avgSecst;
                            console.log("finaltotal.." + finaltotal);

                            var linecount=code.length;
                            var avg = Math.round(total /linecount);
                            console.log('avg secs: ' + avg);
                            // turn seconds back into a time
                            var avgMins = Math.floor(avg / 60);
                            var avgSecs = avg - (60 * avgMins);
                            var avgHrs = Math.floor(avgMins / 60);
                            console.log('hours: ' + avgHrs);
                            avgMins = avgMins - (60 * avgHrs);

                            // add leading zeros for seconds, minutes
                            avgHrs=('0' + avgHrs).slice(-2);
                            avgSecs = ('0' + avgSecs).slice(-2);
                            avgMins = ('0' + avgMins).slice(-2);
                            console.log("avgSecs.." + avgSecs);
                            console.log("avgMins.." + avgMins);
                            // your answer
                            var finalAvgtime = avgHrs + ':' + avgMins + ':' + avgSecs;
                            console.log("finaltime.." + finalAvgtime);

                            var row = '<tr>';
                                row += '<td></td>';
                                row += '<td>' + line1 + '</td>';
                                row += '<td>' + code[k] + '</td>';
                                row += '<td>' + lossname1 + '</td>';
                                row += '<td>' + action1 + '</td>';
                                row += '<td>' + finaltotal + '</td>';
                                row += '<td>' + sepratedarr.length + '</td>';
                                row += '<td>' + finalAvgtime + '</td>';
                                row += '<td>' + Min + '</td>';
                                row += '<td>' + Max + '</td>';
                                // row += '<td>' + '<button class="btn btn-primary" onclick=" showData()">Veiw Deatils<i class="fas fa-user-edit"></i></button>' + '</td>';
                                row += '</tr>';

                                $('#tblLoss tbody').append(row);
                                lossstarttime = 0;
                                lossendtime = 0;
                                finallosscode = 0;
                                lossstarttime = 0;
                                finaltotal = 0;
                                finalAvgtime = 0;
                                lossduration = 0;
                                lossdesc = "";
                                Min = 0;
                                Max = 0;
                                lossname1="";
                          //}
                        }
                            addSerialNumberLoss("tblLoss");
//#endregion
                          
                                                   
                            }
                        // });

                  
                           
                           
                           
                        }
                    
                    }
                }
            });
        }

        var exportTableToExcel = (function () {
                var uri = 'data:application/vnd.ms-excel;base64,'
                    , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>'
                    , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                    , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
                return function (table, filename='') {
                    filename = new Date();
            // Specify file name
            filename = filename ? filename + '.xls' : 'excel_data.xls';

                    if (!table.nodeType) table = document.getElementById(table)
                    var ctx = { worksheet: filename || 'Worksheet', table: table.innerHTML }
                    var link = document.createElement("a");
            link.download =filename;
            link.href = uri + base64(format(template, ctx));
            link.click();
                    //window.location.href = uri + base64(format(template, ctx))
                }
            })()

     
    </script>
    <script>
        $("#new-header").load("header.html");
        $("#new-footer").load("footer.html");
    </script>
</body>

</html>